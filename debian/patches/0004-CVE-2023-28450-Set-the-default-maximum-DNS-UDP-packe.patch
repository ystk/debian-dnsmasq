From: Simon Kelley <simon@thekelleys.org.uk>
Date: Tue, 7 Mar 2023 22:07:46 +0000
Subject: CVE-2023-28450: Set the default maximum DNS UDP packet size to 1232
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: 8bit

The default maximum EDNS.0 UDP packet size was set to 4096 but should
be 1232 because of DNS Flag Day 2020.

Signed-off-by: Bastien Roucari√®s <rouca@debian.org>
origin: https://thekelleys.org.uk/gitweb/?p=dnsmasq.git;a=patch;h=eb92fb32b746f2104b0f370b5b295bb8dd4bd5e5
debian-bug: https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1033165
---
 man/dnsmasq.8 | 3 ++-
 src/config.h  | 4 ++--
 2 files changed, 4 insertions(+), 3 deletions(-)

diff --git a/man/dnsmasq.8 b/man/dnsmasq.8
index 0b8e04f..6a9a04d 100644
--- a/man/dnsmasq.8
+++ b/man/dnsmasq.8
@@ -145,7 +145,8 @@ to zero completely disables DNS function, leaving only DHCP and/or TFTP.
 .TP
 .B \-P, --edns-packet-max=<size>
 Specify the largest EDNS.0 UDP packet which is supported by the DNS
-forwarder. Defaults to 4096, which is the RFC5625-recommended size.
+forwarder. Defaults to 1232, which is the recommended size following the
+DNS flag day in 2020. Only increase if you know what you are doing.
 .TP
 .B \-Q, --query-port=<query_port>
 Send outbound DNS queries from, and listen for their replies on, the
diff --git a/src/config.h b/src/config.h
index c478536..55348a5 100644
--- a/src/config.h
+++ b/src/config.h
@@ -17,8 +17,8 @@
 #define FTABSIZ 150 /* max number of outstanding requests (default) */
 #define MAX_PROCS 20 /* max no children for TCP requests */
 #define CHILD_LIFETIME 150 /* secs 'till terminated (RFC1035 suggests > 120s) */
-#define EDNS_PKTSZ 4096 /* default max EDNS.0 UDP packet from RFC5625 */
-#define SAFE_PKTSZ 1280 /* "go anywhere" UDP packet size */
+#define EDNS_PKTSZ 1232 /* default max EDNS.0 UDP packet from from  /dnsflagday.net/2020 */
+#define SAFE_PKTSZ 1232 /* "go anywhere" UDP packet size, see https://dnsflagday.net/2020/ */
 #define KEYBLOCK_LEN 40 /* choose to mininise fragmentation when storing DNSSEC keys */
 #define DNSSEC_WORK 50 /* Max number of queries to validate one question */
 #define TIMEOUT 10 /* drop UDP queries after TIMEOUT seconds */
